<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<link rel="import" href="bower_components/font-roboto/roboto.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-toast/paper-toast.html">

<link rel="import" href="beta-device-data-element.html">

<dom-module id="beta-add-device" >
<template>
<style>

    paper-button{
        width: 100%;
        font-size: 15px;
        margin-top: 20px;
    }
</style>
            <div id="mainwrapper">
            
            
                
            </div>
    
        <iron-ajax
            auto
           id="devicedataajax"
           method="GET"
           content-type="application/json"
           handle-as="json"
           on-response="onDataResponse">
        </iron-ajax>
    
        <iron-ajax
            auto
           id="sessioncheckajax"
           method="GET"
           url="https://m25lazi.herokuapp.com/api/alpha/me"
           handle-as="json"
           on-response="onSessionResponse">
        </iron-ajax>
    
    <paper-toast id="toastmain" text="Loading..." duration=Infinity>
    </paper-toast>
    
</template>


<script>
	Polymer({
		is:"beta-add-device",
        ready: function(){
            /*
                Check Session token before going forward.
            */
            $("#mainwrapper").hide();
            
            var currentUrl = window.location.href;
            
            var currentLocation = window.location;
            
            var search = currentLocation.search;
            var deviceid = search.replace("?secret=", "");
            
            this.devicesecret = deviceid;
            console.log(this.devicesecret);
            
        },
        properties:{
            devicesecret:{
                type: String
            },
            devicename:{
                type: String
            }
        },
        
        sendDeviceDataRequest:function(){
            console.log("sendCreateDeviceRequest");
            this.$.devicedataajax.url="https://m25lazi.herokuapp.com/api/alpha/devices/"+this.devicesecret;
        },
        
        onDataResponse:function(e){
            console.log("onDataResponse");
            this.$.toastmain.close();
            console.log(this.$.createdeviceajax.lastResponse);
            var res = this.$.createdeviceajax.lastResponse;
            //{"status":1,"devicedata":{"1450718186":23,"1450718195":23.7,"1450718207":22}}
            if(res.status == 0 )
                alert(res.error);
            else{
                if(res.devicedata){
                    var epochTimeArray = Object.keys(res.devicedata);
                    for (var index = 0;  index< epochTimeArray.count; ++index) {
                        var epochTime = epochTimeArray[index];
                        var deviceValue = res.devicedata[epochTime];
                        
                        var d = new Date(0); // The 0 there is the key, which sets the date to the epoch
                        d.setUTCSeconds(epochTime);
                        
                        var timestamp = d.getDate() + "/"
                + (d.getMonth()+1)  + "/" 
                + d.getFullYear() + " @ "  
                + d.getHours() + ":"  
                + d.getMinutes() + ":" 
                + d.getSeconds();
                        
                        var deviceDataPolymerElement = document.createElement('beta-device-data-element');
                        deviceDataPolymerElement.value = deviceValue;
                        deviceDataPolymerElement.timestamp = timestamp;
                        $('#mainwrapper').append(deviceDataPolymerElement);
                    }
                }
                else{
                    
                }
            }
                
        },
        
        onSessionResponse:function(e){
            console.log("onsSessionResponse");
            console.log(this.$.sessioncheckajax.lastResponse);
            var res = this.$.sessioncheckajax.lastResponse;
            if(res.status == 0 ){
                alert("Not Logged in");
            }
            else{
                $("#mainwrapper").show();
                this.sendDeviceDataRequest();
            }
        }

		

	});
</script>

</dom-module>