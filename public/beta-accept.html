<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<link rel="import" href="../bower_components/font-roboto/roboto.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<dom-module id="beta-accept" >
<template>
<style>

    paper-button{
        width: 100%;
        font-size: 15px;
        margin-top: 20px;
    }
	</style>
            <div id="mainwrapper">
            <paper-input-container class="email-label" >
                <label>Email ID</label>
                <input is="iron-input" value={{email::change}}>
            </paper-input-container>
            
            <paper-input-container class="email-label">
                <label>Username</label>
                <input is="iron-input" value={{username::change}}>
            </paper-input-container>
            
            <paper-input-container class="email-label">
                <label>Password</label>
                <input is="iron-input" type="password" value={{password::change}}>
            </paper-input-container>
            
            <paper-input-container class="email-label">
                <label>Code</label>
                <input is="iron-input"  value={{activationcode::change}}>
            </paper-input-container>
            
            <paper-button class="submit" on-click="submitForm">JOIN US!</paper-button>
            </div>
    
        <iron-ajax
           id="betaacceptajax"
           method="POST"
           content-type="application/json"
           url="https://m25lazi.herokuapp.com/api/alpha/user"
           handle-as="json"
           on-response="onActivationResponse">
        </iron-ajax>
    
        <iron-ajax
            auto
           id="sessioncheckajax"
           method="GET"
           url="https://m25lazi.herokuapp.com/api/alpha/me"
           handle-as="json"
           on-response="onSessionResponse">
        </iron-ajax>
    
    <paper-toast id="toastmain" text="Loading..." duration=Infinity>
    </paper-toast>
    
</template>


<script>
	Polymer({
		is:"beta-accept",
        ready: function(){
            /*
                Check Session token before going forward.
            */
            $("#mainwrapper").hide();
        },
        properties:{
            email:{
                type: String
            },
            password:{
                type: String,
            },
            username:{
                type: String
            },
            activationcode:{
                type: String,
            },
        },

		submitForm: function(){
            console.log("submitForm");
            this.$.toastmain.open();
  		    this.sendLoginRequest();
  		},
        
        createRequestBody:function(){
            return JSON.stringify({ "username":this.username,
                                    "code":this.activationcode,
                                    "email":this.email,
                                    "password":this.password});
        },
        sendLoginRequest:function(){
            console.log("sendLoginRequest");
            this.$.betaacceptajax.body=this.createRequestBody();
            console.log(JSON.stringify(this.createRequestBody()));
            this.$.betaacceptajax.generateRequest();
        },
        
        onActivationResponse:function(e){
            console.log("onActivationResponse");
            console.log(this.$.betaacceptajax.lastResponse);
            var res = this.$.betaacceptajax.lastResponse;
            if(res.status == 0 ){
                this.$.toastmain.close();
                alert(res.error);
            }
            else{
                console.log('Account created. Redirecting to profile page');
                window.location.replace("https://m25lazi.herokuapp.com/betaprofile.html");
            }
        },
        
        onSessionResponse:function(e){
            console.log("onsSessionResponse");
            console.log(this.$.sessioncheckajax.lastResponse);
            var res = this.$.sessioncheckajax.lastResponse;
            if(res.status == 0 ){
                $("#mainwrapper").show();
            }
            else{
                console.log('Already logged in. Redirecting to profile page');
                window.location.replace("https://m25lazi.herokuapp.com/betaprofile.html");
            }
        }

		

	});
</script>

</dom-module>